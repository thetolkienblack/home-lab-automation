# CheckMK Apache SSL/TLS Configuration
# Generated by Ansible - Do not edit manually

{% if ansible_os_family == "Debian" %}
<IfModule mod_ssl.c>
    <VirtualHost _default_:{{ checkmk_server_https_port }}>
        ServerAdmin webmaster@{{ ansible_domain }}
        ServerName {{ checkmk_apache_server_name }}

        DocumentRoot /opt/omd/sites/{{ checkmk_site_id }}/var/www

        # SSL Configuration
        SSLEngine on
        SSLCertificateFile {{ _checkmk_tls_cert_file }}
        SSLCertificateKeyFile {{ _checkmk_tls_key_file }}

        # Modern SSL Configuration
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
        SSLHonorCipherOrder off
        SSLSessionTickets off

        # HSTS (optional, uncomment if desired)
        # Header always set Strict-Transport-Security "max-age=63072000"

        # Logging
        ErrorLog ${APACHE_LOG_DIR}/checkmk-ssl-error.log
        CustomLog ${APACHE_LOG_DIR}/checkmk-ssl-access.log combined

        # CheckMK Site Configuration
        <Location /{{ checkmk_site_id }}>
            Order allow,deny
            Allow from all
        </Location>

        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteRule ^/$ /{{ checkmk_site_id }}/ [R,L]
        </IfModule>
    </VirtualHost>
</IfModule>

{% else %}
# RHEL/CentOS Configuration
<VirtualHost *:{{ checkmk_server_https_port }}>
    ServerAdmin webmaster@{{ ansible_domain }}
    ServerName {{ checkmk_apache_server_name }}

    DocumentRoot /opt/omd/sites/{{ checkmk_site_id }}/var/www

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ _checkmk_tls_cert_file }}
    SSLCertificateKeyFile {{ _checkmk_tls_key_file }}

    # Modern SSL Configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # Logging
    ErrorLog /var/log/httpd/checkmk-ssl-error.log
    CustomLog /var/log/httpd/checkmk-ssl-access.log combined

    # CheckMK Site Configuration
    <Location /{{ checkmk_site_id }}>
        Require all granted
    </Location>

    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^/$ /{{ checkmk_site_id }}/ [R,L]
    </IfModule>
</VirtualHost>
{% endif %}
