# Generated by Ansible - elk_stack role
# Beats input pipeline configuration

input {
  beats {
    port => {{ logstash_beats_port }}
    host => "{{ logstash_http_host }}"
  }
}

filter {
  # Add common fields
  mutate {
    add_field => {
      "[@metadata][target_index]" => "beats-%{+YYYY.MM.dd}"
    }
  }

  # Parse JSON if present
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add geoip data for IP addresses
  if [source][ip] {
    geoip {
      source => "[source][ip]"
      target => "[source][geo]"
    }
  }
}

output {
  elasticsearch {
    hosts => {{ logstash_elasticsearch_hosts | to_json }}
{% if elk_security_enabled %}
    user => "{{ logstash_elasticsearch_user }}"
    password => "{{ logstash_elasticsearch_password }}"
{% endif %}
    index => "%{[@metadata][target_index]}"
    manage_template => true
  }

  # Optional: output to stdout for debugging
  # stdout {
  #   codec => rubydebug
  # }
}
